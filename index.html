<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sensor Calibration Tool v2.0</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const SensorCalibrationTool = () => {
            const [expectedFile, setExpectedFile] = useState(null);
            const [actualFile, setActualFile] = useState(null);
            const [circuitDescription, setCircuitDescription] = useState('');
            const [geminiApiKey, setGeminiApiKey] = useState('');
            const [processing, setProcessing] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [aiGenerating, setAiGenerating] = useState(false);
            
            // Debug Chat States
            const [debugMode, setDebugMode] = useState(false);
            const [chatHistory, setChatHistory] = useState([]);
            const [userMessage, setUserMessage] = useState('');
            const [errorImage, setErrorImage] = useState(null);
            const [debugProcessing, setDebugProcessing] = useState(false);
            const [codeVersions, setCodeVersions] = useState([]);
            const [currentVersion, setCurrentVersion] = useState(0);
            const chatEndRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setGeminiApiKey(savedKey);
                
                const savedChat = localStorage.getItem('debug_chat_history');
                if (savedChat) setChatHistory(JSON.parse(savedChat));
                
                const savedVersions = localStorage.getItem('code_versions');
                if (savedVersions) setCodeVersions(JSON.parse(savedVersions));
            }, []);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatHistory]);

            const saveApiKey = (key) => {
                setGeminiApiKey(key);
                if (key) {
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    localStorage.removeItem('gemini_api_key');
                }
            };

            const saveChatHistory = (history) => {
                localStorage.setItem('debug_chat_history', JSON.stringify(history));
            };

            const saveCodeVersions = (versions) => {
                localStorage.setItem('code_versions', JSON.stringify(versions));
            };

            const SENSOR_CONFIGS = {
                'voltage sensor': { type: 'analog', pin: 'ADC', unit: 'V' },
                'current sensor': { type: 'analog', pin: 'ADC', unit: 'A' },
                'load cell': { type: 'analog', pin: 'ADC', unit: 'kg' },
                'speed sensor': { type: 'digital', pin: 'GPIO', unit: 'RPM' },
                'vibration sensor': { type: 'analog', pin: 'ADC', unit: 'g' },
                'humidity sensor': { type: 'digital', pin: 'GPIO', unit: '%' },
                'temperature sensor': { type: 'analog', pin: 'ADC', unit: 'Â°C' }
            };

            const parseCSV = (text) => {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const timeIndex = headers.findIndex(h => h.includes('time') || h.includes('timestamp'));
                if (timeIndex === -1) throw new Error('No timestamp column found');
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length === headers.length) {
                        const row = { timestamp: parseFloat(values[timeIndex]) };
                        headers.forEach((header, idx) => {
                            if (idx !== timeIndex) row[header] = parseFloat(values[idx]);
                        });
                        data.push(row);
                    }
                }
                return { headers: headers.filter((_, idx) => idx !== timeIndex), data };
            };

            const findClosestTimestamp = (targetTime, dataArray, tolerance = 0.1) => {
                return dataArray.find(row => Math.abs(row.timestamp - targetTime) <= tolerance);
            };

            const linearRegression = (xArray, yArray) => {
                const n = xArray.length;
                const sumX = xArray.reduce((a, b) => a + b, 0);
                const sumY = yArray.reduce((a, b) => a + b, 0);
                const sumXY = xArray.reduce((sum, x, i) => sum + x * yArray[i], 0);
                const sumXX = xArray.reduce((sum, x) => sum + x * x, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                const yMean = sumY / n;
                const ssTotal = yArray.reduce((sum, y) => sum + Math.pow(y - yMean, 2), 0);
                const ssResidual = yArray.reduce((sum, y, i) => sum + Math.pow(y - (slope * xArray[i] + intercept), 2), 0);
                const rSquared = 1 - (ssResidual / ssTotal);
                
                return { slope, intercept, rSquared };
            };

            const generateAIArduinoCode = async (calibrations, description, errorCSV, previousCode = null, debugContext = null) => {
                if (!geminiApiKey) throw new Error('Gemini API key required');

                setAiGenerating(true);
                const sensors = Object.keys(calibrations);
                const calibrationSummary = sensors.map(sensor => {
                    const cal = calibrations[sensor];
                    return `${sensor}: slope=${cal.slope.toFixed(6)}, intercept=${cal.intercept.toFixed(6)}, RÂ²=${cal.rSquared.toFixed(4)}`;
                }).join('\n');

                let prompt = previousCode ? 
                    `You are debugging Arduino code for ESP32/ESP8266. The user reported an issue.

PREVIOUS CODE:
\`\`\`cpp
${previousCode}
\`\`\`

DEBUG CONTEXT:
${debugContext || 'User needs help fixing the code'}

CIRCUIT DESCRIPTION:
${description}

CALIBRATION DATA:
${calibrationSummary}

Please analyze the issue and provide:
1. Explanation of what went wrong
2. The complete fixed Arduino code
3. What specific changes you made

Format your response as:
## Issue Analysis
[Your analysis here]

## Changes Made
[Bullet points of changes]

## Fixed Code
\`\`\`cpp
[Complete corrected code here]
\`\`\`
` :
                    `Generate production-ready Arduino code for ESP32/ESP8266:

CIRCUIT DESCRIPTION:
${description || 'Standard multi-sensor setup'}

SENSORS:
${sensors.join(', ')}

CALIBRATION DATA:
${calibrationSummary}

ERROR CSV SAMPLE:
${errorCSV.split('\n').slice(0, 8).join('\n')}

REQUIREMENTS:
- Complete Arduino .ino code
- Apply calibration: calibrated = (raw * slope) + intercept
- Appropriate pins (ADC for analog, GPIO for digital)
- Serial CSV output with timestamp
- Error handling and bounds checking
- Comments explaining circuit
- 100ms sampling rate

Generate ONLY the code, starting with comments.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 8192,
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Gemini API Error: ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();
                    let generatedText = data.candidates[0]?.content?.parts[0]?.text;

                    if (!generatedText) throw new Error('No response from AI');

                    // Extract code and explanation
                    const codeMatch = generatedText.match(/```(?:cpp|c|arduino)?\n([\s\S]*?)```/);
                    const code = codeMatch ? codeMatch[1].trim() : generatedText.trim();
                    
                    const explanation = previousCode ? 
                        generatedText.split('```')[0].trim() : 
                        'Initial code generated based on calibration data';

                    return { code, explanation };
                } catch (err) {
                    console.error('AI Error:', err);
                    throw err;
                } finally {
                    setAiGenerating(false);
                }
            };

            const generateAIDebugResponse = async (userInput, imageBase64 = null) => {
                if (!geminiApiKey) throw new Error('Gemini API key required');

                const currentCode = codeVersions[currentVersion]?.code || '';
                const context = `
CURRENT ARDUINO CODE (Version ${currentVersion + 1}):
\`\`\`cpp
${currentCode}
\`\`\`

CIRCUIT DESCRIPTION:
${circuitDescription}

CALIBRATION INFO:
${results ? Object.entries(results.calibrations).map(([s, c]) => 
    `${s}: slope=${c.slope.toFixed(4)}, intercept=${c.intercept.toFixed(4)}`).join('\n') : 'N/A'}

USER ISSUE:
${userInput}
`;

                const parts = [{ text: context }];
                if (imageBase64) {
                    parts.push({
                        inline_data: {
                            mime_type: 'image/jpeg',
                            data: imageBase64
                        }
                    });
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts }],
                            generationConfig: {
                                temperature: 0.8,
                                maxOutputTokens: 4096,
                            }
                        })
                    });

                    if (!response.ok) throw new Error('Debug AI request failed');
                    const data = await response.json();
                    return data.candidates[0]?.content?.parts[0]?.text || 'Could not generate response';
                } catch (err) {
                    console.error('Debug AI Error:', err);
                    throw err;
                }
            };

            const processCalibration = async () => {
                setProcessing(true);
                setError(null);
                setResults(null);
                setCodeVersions([]);
                setCurrentVersion(0);
                setChatHistory([]);

                try {
                    const expectedText = await expectedFile.text();
                    const actualText = await actualFile.text();
                    const expectedData = parseCSV(expectedText);
                    const actualData = parseCSV(actualText);
                    
                    const sensorCalibrations = {};
                    const errorRates = [];
                    
                    expectedData.headers.forEach(sensor => {
                        if (!actualData.headers.includes(sensor)) return;
                        
                        const expectedValues = [];
                        const actualValues = [];
                        const timestamps = [];
                        
                        expectedData.data.forEach(expectedRow => {
                            const actualRow = findClosestTimestamp(expectedRow.timestamp, actualData.data);
                            if (actualRow && !isNaN(expectedRow[sensor]) && !isNaN(actualRow[sensor])) {
                                expectedValues.push(expectedRow[sensor]);
                                actualValues.push(actualRow[sensor]);
                                timestamps.push(expectedRow.timestamp);
                            }
                        });
                        
                        if (expectedValues.length < 2) return;
                        
                        const regression = linearRegression(actualValues, expectedValues);
                        const errors = actualValues.map((actual, i) => {
                            const expected = expectedValues[i];
                            const percentError = ((actual - expected) / expected) * 100;
                            return {
                                timestamp: timestamps[i],
                                sensor,
                                expected,
                                actual,
                                error: actual - expected,
                                percentError: isFinite(percentError) ? percentError : 0
                            };
                        });
                        
                        sensorCalibrations[sensor] = {
                            slope: regression.slope,
                            intercept: regression.intercept,
                            rSquared: regression.rSquared,
                            avgError: errors.reduce((sum, e) => sum + Math.abs(e.percentError), 0) / errors.length
                        };
                        errorRates.push(...errors);
                    });
                    
                    const errorCSV = generateErrorCSV(errorRates);
                    const { code: arduinoCode, explanation } = await generateAIArduinoCode(sensorCalibrations, circuitDescription, errorCSV);
                    
                    const version = {
                        version: 1,
                        code: arduinoCode,
                        explanation: explanation || 'Initial AI-generated code',
                        timestamp: new Date().toLocaleString(),
                        calibrations: sensorCalibrations
                    };
                    
                    const versions = [version];
                    setCodeVersions(versions);
                    saveCodeVersions(versions);
                    setCurrentVersion(0);
                    
                    setResults({
                        calibrations: sensorCalibrations,
                        errorCSV,
                        arduinoCode,
                        totalDataPoints: errorRates.length,
                        aiGenerated: true
                    });
                    
                    setChatHistory([{
                        role: 'assistant',
                        content: `âœ… Code generated successfully! Version 1 is ready. If you encounter any issues while testing, use the debug chat below.`,
                        timestamp: new Date().toLocaleString()
                    }]);
                    
                } catch (err) {
                    setError(err.message);
                } finally {
                    setProcessing(false);
                }
            };

            const handleDebugMessage = async () => {
                if (!userMessage.trim() && !errorImage) return;

                const userMsg = {
                    role: 'user',
                    content: userMessage,
                    image: errorImage,
                    timestamp: new Date().toLocaleString()
                };

                const newHistory = [...chatHistory, userMsg];
                setChatHistory(newHistory);
                saveChatHistory(newHistory);
                setUserMessage('');
                setErrorImage(null);
                setDebugProcessing(true);

                try {
                    let imageBase64 = null;
                    if (errorImage) {
                        imageBase64 = errorImage.split(',')[1];
                    }

                    const aiResponse = await generateAIDebugResponse(userMessage, imageBase64);
                    
                    // Check if AI suggests code fix
                    const codeMatch = aiResponse.match(/```(?:cpp|c|arduino)?\n([\s\S]*?)```/);
                    
                    if (codeMatch) {
                        const fixedCode = codeMatch[1].trim();
                        const explanation = aiResponse.split('```')[0].trim();
                        
                        const newVersion = {
                            version: codeVersions.length + 1,
                            code: fixedCode,
                            explanation: explanation || 'Code updated based on debug feedback',
                            timestamp: new Date().toLocaleString(),
                            calibrations: results.calibrations
                        };
                        
                        const updatedVersions = [...codeVersions, newVersion];
                        setCodeVersions(updatedVersions);
                        saveCodeVersions(updatedVersions);
                        setCurrentVersion(updatedVersions.length - 1);
                        
                        const assistantMsg = {
                            role: 'assistant',
                            content: `${explanation}\n\nâœ… **Updated Code (Version ${newVersion.version})**\n\nI've generated a fixed version. Download it using the button below.`,
                            hasCode: true,
                            timestamp: new Date().toLocaleString()
                        };
                        
                        const finalHistory = [...newHistory, assistantMsg];
                        setChatHistory(finalHistory);
                        saveChatHistory(finalHistory);
                    } else {
                        const assistantMsg = {
                            role: 'assistant',
                            content: aiResponse,
                            timestamp: new Date().toLocaleString()
                        };
                        
                        const finalHistory = [...newHistory, assistantMsg];
                        setChatHistory(finalHistory);
                        saveChatHistory(finalHistory);
                    }
                } catch (err) {
                    const errorMsg = {
                        role: 'assistant',
                        content: `âŒ Error: ${err.message}. Please try again or rephrase your question.`,
                        timestamp: new Date().toLocaleString()
                    };
                    setChatHistory([...newHistory, errorMsg]);
                } finally {
                    setDebugProcessing(false);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setErrorImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const generateErrorCSV = (errorRates) => {
                let csv = 'Timestamp,Sensor,Expected,Actual,Error,Percent_Error\n';
                errorRates.forEach(row => {
                    csv += `${row.timestamp},${row.sensor},${row.expected},${row.actual},${row.error},${row.percentError.toFixed(4)}\n`;
                });
                return csv;
            };

            const downloadFile = (content, filename) => {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };

            const copyToClipboard = async (text, buttonElement) => {
                try {
                    await navigator.clipboard.writeText(text);
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = 'âœ“ Copied!';
                    buttonElement.classList.add('bg-green-600');
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.classList.remove('bg-green-600');
                    }, 2000);
                } catch (err) {
                    alert('Failed to copy. Please select and copy manually.');
                }
            };

            const exportDetailedPrompt = () => {
                const prompt = `I'm working on an ESP32/ESP8266 sensor calibration project and need help debugging Arduino code.

## CIRCUIT DESCRIPTION:
${circuitDescription || 'No circuit description provided'}

## SENSORS BEING CALIBRATED:
${results ? Object.keys(results.calibrations).join(', ') : 'None'}

## CALIBRATION DATA:
${results ? Object.entries(results.calibrations).map(([sensor, cal]) => 
    `${sensor}:
  - Slope: ${cal.slope.toFixed(6)}
  - Intercept: ${cal.intercept.toFixed(6)}
  - RÂ² (goodness of fit): ${cal.rSquared.toFixed(4)}
  - Average error: ${cal.avgError.toFixed(2)}%`
).join('\n\n') : 'No calibration data'}

## CURRENT ARDUINO CODE (Version ${currentVersion + 1}):
\`\`\`cpp
${codeVersions[currentVersion]?.code || 'No code generated yet'}
\`\`\`

## DEBUGGING HISTORY:
${chatHistory.map(msg => `${msg.role.toUpperCase()}: ${msg.content}`).join('\n\n')}

## PROBLEM DESCRIPTION:
[Describe your current issue here]

## WHAT I NEED:
Please help me fix this Arduino code. Analyze the circuit, calibration data, and previous debugging attempts to provide a working solution.`;

                downloadFile(prompt, 'debug_prompt_for_ai.txt');
            };

            const clearDebugHistory = () => {
                if (confirm('Clear all debug chat history? Code versions will be preserved.')) {
                    setChatHistory([]);
                    localStorage.removeItem('debug_chat_history');
                }
            };

            const exportChatLog = () => {
                const log = chatHistory.map(msg => 
                    `[${msg.timestamp}] ${msg.role.toUpperCase()}: ${msg.content}`
                ).join('\n\n');
                downloadFile(log, 'debug_chat_log.txt');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            {/* Header */}
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-3">
                                    <svg className="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                    <div>
                                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">AI Sensor Calibration v2.0</h1>
                                        <p className="text-gray-600 text-sm md:text-base">With Interactive Debug Assistant â€¢ Powered by Gemini 2.5 Flash</p>
                                    </div>
                                </div>
                                <div className="text-xs md:text-sm text-gray-500">
                                    {codeVersions.length > 0 && `Version ${currentVersion + 1}/${codeVersions.length}`}
                                </div>
                            </div>

                            {/* API Key */}
                            <div className="mb-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 md:p-6 border-2 border-purple-200">
                                <div className="flex items-start gap-3">
                                    <svg className="w-6 h-6 text-purple-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                    </svg>
                                    <div className="flex-1">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Gemini API Key {geminiApiKey && 'âœ“'}
                                        </label>
                                        <input
                                            type="password"
                                            className="w-full border-2 border-purple-300 rounded-lg p-2 md:p-3 focus:border-purple-500 focus:outline-none font-mono text-sm"
                                            placeholder="AIza... (get from https://aistudio.google.com/app/apikey)"
                                            value={geminiApiKey}
                                            onChange={(e) => saveApiKey(e.target.value)}
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* File Upload */}
                            <div className="grid md:grid-cols-2 gap-4 md:gap-6 mb-6">
                                <div className="border-2 border-dashed border-indigo-300 rounded-lg p-4 md:p-6 hover:border-indigo-500 transition">
                                    <label className="block cursor-pointer">
                                        <div className="flex flex-col items-center gap-2">
                                            <svg className="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                            </svg>
                                            <span className="font-semibold text-gray-700 text-sm md:text-base">Expected CSV</span>
                                            {expectedFile && <span className="text-sm text-green-600">âœ“ {expectedFile.name}</span>}
                                        </div>
                                        <input type="file" accept=".csv" className="hidden" onChange={(e) => setExpectedFile(e.target.files[0])} />
                                    </label>
                                </div>

                                <div className="border-2 border-dashed border-indigo-300 rounded-lg p-4 md:p-6 hover:border-indigo-500 transition">
                                    <label className="block cursor-pointer">
                                        <div className="flex flex-col items-center gap-2">
                                            <svg className="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                            </svg>
                                            <span className="font-semibold text-gray-700 text-sm md:text-base">Actual Sensor CSV</span>
                                            {actualFile && <span className="text-sm text-green-600">âœ“ {actualFile.name}</span>}
                                        </div>
                                        <input type="file" accept=".csv" className="hidden" onChange={(e) => setActualFile(e.target.files[0])} />
                                    </label>
                                </div>
                            </div>

                            {/* Circuit Description */}
                            <div className="mb-6">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    ðŸ¤– Circuit Description
                                </label>
                                <textarea
                                    className="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-purple-500 focus:outline-none text-sm md:text-base"
                                    rows="4"
                                    placeholder="Describe your circuit setup in detail for better AI code generation..."
                                    value={circuitDescription}
                                    onChange={(e) => setCircuitDescription(e.target.value)}
                                />
                            </div>

                            {/* Generate Button */}
                            <button
                                onClick={processCalibration}
                                disabled={!expectedFile || !actualFile || processing || !geminiApiKey}
                                className="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 md:py-4 rounded-lg transition flex items-center justify-center gap-2 shadow-lg text-sm md:text-base"
                            >
                                {processing ? (
                                    <>
                                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                        {aiGenerating ? 'AI Generating...' : 'Processing...'}
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        Generate AI Code
                                    </>
                                )}
                            </button>

                            {error && (
                                <div className="mt-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
                                    <p className="text-red-700 text-sm">{error}</p>
                                </div>
                            )}

                            {/* Results */}
                            {results && (
                                <div className="mt-8 space-y-6">
                                    <div className="bg-gradient-to-r from-green-50 to-blue-50 border-l-4 border-green-500 p-4 rounded">
                                        <span className="text-green-800 font-semibold text-sm md:text-base">
                                            âœ“ Code Ready! {results.totalDataPoints} data points processed
                                        </span>
                                    </div>

                                    {/* Calibration Results */}
                                    <div className="bg-gray-50 rounded-lg p-4 md:p-6">
                                        <h3 className="text-lg md:text-xl font-bold text-gray-800 mb-4">ðŸ“Š Calibration Results</h3>
                                        <div className="space-y-3">
                                            {Object.entries(results.calibrations).map(([sensor, cal]) => (
                                                <div key={sensor} className="bg-white p-3 md:p-4 rounded-lg shadow-sm">
                                                    <h4 className="font-semibold text-gray-700 capitalize text-sm md:text-base">{sensor}</h4>
                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mt-2 text-xs md:text-sm">
                                                        <div><span className="text-gray-600">Slope:</span> <span className="ml-2 font-mono">{cal.slope.toFixed(6)}</span></div>
                                                        <div><span className="text-gray-600">Intercept:</span> <span className="ml-2 font-mono">{cal.intercept.toFixed(6)}</span></div>
                                                        <div><span className="text-gray-600">RÂ²:</span> <span className="ml-2 font-mono">{cal.rSquared.toFixed(4)}</span></div>
                                                        <div><span className="text-gray-600">Avg Error:</span> <span className="ml-2 font-mono">{cal.avgError.toFixed(2)}%</span></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Version Control */}
                                    {codeVersions.length > 0 && (
                                        <div className="bg-blue-50 rounded-lg p-4 md:p-6 border-2 border-blue-200">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-lg md:text-xl font-bold text-gray-800">ðŸ“š Code Versions</h3>
                                                <span className="text-sm text-gray-600">v{currentVersion + 1} of {codeVersions.length}</span>
                                            </div>
                                            <div className="flex flex-wrap gap-2 mb-4">
                                                {codeVersions.map((ver, idx) => (
                                                    <button
                                                        key={idx}
                                                        onClick={() => setCurrentVersion(idx)}
                                                        className={`px-3 py-2 rounded-lg text-sm font-semibold transition ${
                                                            idx === currentVersion
                                                                ? 'bg-blue-600 text-white'
                                                                : 'bg-white text-gray-700 hover:bg-blue-100'
                                                        }`}
                                                    >
                                                        v{ver.version}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="bg-white rounded-lg p-4 text-sm">
                                                <div className="text-gray-600 mb-2">
                                                    <strong>Generated:</strong> {codeVersions[currentVersion].timestamp}
                                                </div>
                                                <div className="text-gray-700">
                                                    <strong>Changes:</strong> {codeVersions[currentVersion].explanation}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Download Buttons */}
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <button
                                            onClick={() => downloadFile(results.errorCSV, 'calibration_errors.csv')}
                                            className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2 text-sm md:text-base"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                            </svg>
                                            Error CSV
                                        </button>
                                        <button
                                            onClick={() => downloadFile(codeVersions[currentVersion].code, `calibrated_code_v${codeVersions[currentVersion].version}.ino`)}
                                            className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2 shadow-lg text-sm md:text-base"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                            </svg>
                                            Arduino Code v{codeVersions[currentVersion].version}
                                        </button>
                                    </div>

                                    {/* Code Preview */}
                                    <div className="bg-gray-900 rounded-lg p-4 md:p-6 overflow-x-auto">
                                        <div className="flex items-center justify-between mb-3">
                                            <h3 className="text-white font-bold text-sm md:text-base">ðŸ’» Code Preview (v{codeVersions[currentVersion].version})</h3>
                                            <button
                                                onClick={(e) => copyToClipboard(codeVersions[currentVersion].code, e.target)}
                                                className="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs md:text-sm flex items-center gap-2 transition"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                </svg>
                                                Copy
                                            </button>
                                        </div>
                                        <pre className="text-green-400 text-xs md:text-sm font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
                                            {codeVersions[currentVersion].code}
                                        </pre>
                                    </div>

                                    {/* Debug Toggle Button */}
                                    <button
                                        onClick={() => setDebugMode(!debugMode)}
                                        className={`w-full py-4 rounded-lg font-bold text-white transition flex items-center justify-center gap-2 ${
                                            debugMode 
                                                ? 'bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600' 
                                                : 'bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600'
                                        }`}
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                        </svg>
                                        {debugMode ? 'ðŸ”´ Close Debug Assistant' : 'ðŸ¤– Need Help? Open Debug Assistant'}
                                    </button>

                                    {/* Debug Chat Interface */}
                                    {debugMode && (
                                        <div className="bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg p-4 md:p-6 border-2 border-blue-300 shadow-xl">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                                                    <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                                    </svg>
                                                    AI Debug Assistant
                                                </h3>
                                                <div className="flex gap-2">
                                                    <button onClick={exportDetailedPrompt} className="text-xs bg-yellow-100 text-yellow-700 px-3 py-1 rounded-lg hover:bg-yellow-200 font-semibold flex items-center gap-1">
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                                        </svg>
                                                        Export for Other AI
                                                    </button>
                                                    <button onClick={exportChatLog} className="text-xs bg-white px-3 py-1 rounded-lg hover:bg-gray-100">
                                                        Export Chat
                                                    </button>
                                                    <button onClick={clearDebugHistory} className="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-lg hover:bg-red-200">
                                                        Clear History
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Chat History */}
                                            <div className="bg-white rounded-lg p-4 mb-4 max-h-96 overflow-y-auto border-2 border-gray-200">
                                                {chatHistory.length === 0 ? (
                                                    <div className="text-center text-gray-500 py-8">
                                                        <svg className="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                                        </svg>
                                                        <p className="font-semibold">No debug messages yet</p>
                                                        <p className="text-sm mt-2">Upload an error screenshot or describe your issue below</p>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4">
                                                        {chatHistory.map((msg, idx) => (
                                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                                <div className={`max-w-[80%] rounded-lg p-3 ${
                                                                    msg.role === 'user' 
                                                                        ? 'bg-blue-600 text-white' 
                                                                        : 'bg-gray-100 text-gray-800'
                                                                }`}>
                                                                    <div className="text-xs opacity-75 mb-1">{msg.timestamp}</div>
                                                                    {msg.image && (
                                                                        <img src={msg.image} alt="Error screenshot" className="rounded mb-2 max-w-full h-auto" />
                                                                    )}
                                                                    <div className="text-sm whitespace-pre-wrap">{msg.content}</div>
                                                                    {msg.hasCode && (
                                                                        <div className="mt-2 text-xs bg-green-600 text-white px-3 py-1 rounded inline-block">
                                                                            âœ“ New code version generated
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        <div ref={chatEndRef} />
                                                    </div>
                                                )}
                                            </div>

                                            {/* Image Preview */}
                                            {errorImage && (
                                                <div className="mb-4 bg-white rounded-lg p-3 border-2 border-blue-300">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="text-sm font-semibold">Image attached:</span>
                                                        <button onClick={() => setErrorImage(null)} className="text-red-600 text-xs hover:underline">
                                                            Remove
                                                        </button>
                                                    </div>
                                                    <img src={errorImage} alt="Error" className="rounded max-h-48 mx-auto" />
                                                </div>
                                            )}

                                            {/* Input Area */}
                                            <div className="space-y-3">
                                                <textarea
                                                    value={userMessage}
                                                    onChange={(e) => setUserMessage(e.target.value)}
                                                    placeholder="Describe your error or issue... (e.g., 'Code uploads but sensor shows 0.00', 'analogRead error on line 45', 'ESP32 keeps rebooting')"
                                                    className="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:outline-none text-sm"
                                                    rows="3"
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter' && e.ctrlKey) handleDebugMessage();
                                                    }}
                                                />
                                                <div className="flex gap-2">
                                                    <label className="flex-1 bg-white border-2 border-gray-300 hover:border-blue-500 rounded-lg p-3 cursor-pointer transition flex items-center justify-center gap-2 text-sm font-semibold">
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        {errorImage ? 'Change Image' : 'Upload Screenshot'}
                                                        <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                                    </label>
                                                    <button
                                                        onClick={handleDebugMessage}
                                                        disabled={debugProcessing || (!userMessage.trim() && !errorImage)}
                                                        className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2 text-sm"
                                                    >
                                                        {debugProcessing ? (
                                                            <>
                                                                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                                                Analyzing...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                                                </svg>
                                                                Send
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                                <p className="text-xs text-gray-600">
                                                    ðŸ’¡ Tip: Upload error screenshots, paste compiler errors, or describe runtime issues. Press Ctrl+Enter to send.
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Instructions */}
                            <div className="mt-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 md:p-6 border-2 border-blue-200">
                                <h3 className="font-bold text-gray-800 mb-3 text-sm md:text-base">ðŸ“‹ How to Use v2.0</h3>
                                <ol className="list-decimal list-inside space-y-2 text-gray-700 text-xs md:text-sm">
                                    <li>Get your free Gemini API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-purple-600 underline">Google AI Studio</a></li>
                                    <li>Upload expected CSV (Simulink) and actual CSV (ESP32/ESP8266)</li>
                                    <li>Describe your circuit setup in detail</li>
                                    <li>Generate AI-powered calibrated code</li>
                                    <li><strong>NEW:</strong> Test the code on your hardware</li>
                                    <li><strong>NEW:</strong> If errors occur, open Debug Assistant</li>
                                    <li><strong>NEW:</strong> Upload error screenshots or paste error messages</li>
                                    <li><strong>NEW:</strong> Get fixed code instantly with version control</li>
                                    <li>Download the final working version and deploy!</li>
                                </ol>
                                <div className="mt-4 p-3 bg-white rounded-lg border border-purple-200">
                                    <h4 className="font-bold text-sm text-gray-800 mb-2">ðŸ†• New Features:</h4>
                                    <ul className="text-xs text-gray-600 space-y-1">
                                        <li>âœ“ <strong>Interactive Debug Chat:</strong> Get help fixing code issues</li>
                                        <li>âœ“ <strong>Image Upload:</strong> Send error screenshots for AI analysis</li>
                                        <li>âœ“ <strong>Version Control:</strong> Track all code iterations</li>
                                        <li>âœ“ <strong>Smart Context:</strong> AI remembers your circuit and previous errors</li>
                                        <li>âœ“ <strong>Change Explanations:</strong> See what was fixed in each version</li>
                                        <li>âœ“ <strong>Chat Export:</strong> Save debug conversations for documentation</li>
                                    </ul>
                                </div>
                            </div>

                            {/* Footer */}
                            <div className="mt-6 text-center text-xs md:text-sm text-gray-500">
                                <p>Sensor Calibration Tool v2.0 | Built with â¤ï¸ for ECE Engineers | Powered by Gemini 2.5 Flash</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SensorCalibrationTool />, document.getElementById('root'));
    </script>
</body>
</html>